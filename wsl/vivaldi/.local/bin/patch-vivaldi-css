#!/usr/bin/env python3

from os import path, system
from subprocess import run, PIPE

custom_css = """/* Hide Vivaldi menu button
 * -- a space is left behind where the button's container resides
 */
button.vivaldi {
  display: none !important;
}
/* Move tabs left to remove empty space from menu button container
* -- position of tabs changes dynamically based on the width of the window
* -- using -1% here ensures things will line up well when the window is
*    maximized at 1440p
*/
#tabs-container.top {
  margin-left: -1%;
}
"""

global_install_path = '/mnt/c/Program\ Files/Vivaldi'
local_install_path = '/mnt/c/Users/*/AppData/Local/Vivaldi'

css_file_path = '/Application/*/resources/vivaldi/style/common.css'

fuzzy_path = None
if path.exists(global_install_path):
    print('Found Vivaldi installed globally...')
    fuzzy_path = global_install_path + css_file_path
else:
    print('Assuming Vivaldi was installed locally...')
    fuzzy_path = local_install_path + css_file_path

find_command = 'find ' + fuzzy_path
find_path = run(['bash', '-c', find_command], stdout=PIPE)
actual_path = find_path.stdout.decode('utf-8').rstrip()

if path.isfile(actual_path):
    tail_file = run(['tail', '-14', actual_path], stdout=PIPE)
    css_file_end = tail_file.stdout.decode('utf-8')
    if (css_file_end == custom_css):
        print('Vivaldi CSS file already patched!')
    else:
        print('Patching Vivaldi CSS file...')
        with open(actual_path, 'a') as css_file:
            css_file.write(custom_css)
            print('Vivaldi CSS file patched successfully!')